{
	local_certs
	auto_https disable_redirects # This is required to avoid redirect loops when using a reverse proxy and cloud load balancers.
	{$CADDY_GLOBAL_OPTIONS}

	frankenphp {
		#worker /path/to/your/worker.php
		{$FRANKENPHP_CONFIG}
	}

	# https://caddyserver.com/docs/caddyfile/directives#sorting-algorithm
	order php_server before file_server
	order php before file_server
	order wp_cache before rewrite
	order request_header before wp_cache
}

{$CADDY_EXTRA_CONFIG}

## Need to set all hosts with port for the cloud.
# You may not have the hostname being called due to dynamic IPs and load balancers.
# Allowing all hosts on port 80 for health checks, local dev & cases where the hostname is unknown.
{$SERVER_NAME:localhost} {
	@static {
		file
		path *.ico *.css *.js *.gif *.jpg *.jpeg *.png *.svg *.woff
	}

	root * /var/www/html/
	encode br zstd gzip
	
	# Cabeçalhos de segurança
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Frame-Options "SAMEORIGIN"
		X-Content-Type-Options "nosniff"
		X-XSS-Protection "1; mode=block"
		Referrer-Policy "no-referrer-when-downgrade"
	}

	# Bloquear XML-RPC e trackbacks
	respond /xmlrpc.php 403
	respond /wp-trackback.php 403

	# Limite de tentativas de login (POST em wp-login.php)
	@loginPOST {
		method POST
		path /wp-login.php
	}
	rate_limit @loginPOST 10 1m

	# Bloquear enumeração de usuários via querystring ?author=
	@enumUsers {
		path_regexp enum ^/\?author=\d+
	}
	respond @enumUsers 404

	# Bloquear acesso à REST API de usuários
	@restUsers {
		path_regexp restUsers ^/wp-json/wp/v2/users
	}
	respond @restUsers 403

	# Bloquear WP-Admin apenas para tentativas POST (brute force), permitindo GET e admin-ajax.php
	@adminPOST {
		method POST
		path /wp-admin/*
	}
	respond @adminPOST 403

	# Bloquear execução de PHP em wp-content subdiretórios sensíveis
	@blockContentPHP {
		path_regexp blockContentPHP ^/wp-content/(plugins|themes|mu-plugins|uploads)/.*\.php$
	}
	respond @blockContentPHP 403

	# Bloquear acesso a arquivos sensíveis e ocultos
	@denyConfig {
		path /composer.json /composer.lock /wp-config.php /wp-config-docker.php /readme.html /.htaccess
	}
	respond @denyConfig 404

	wp_cache {
		loc {$CACHE_LOC:/var/www/html/wp-content/cache}
		cache_response_codes {$CACHE_RESPONSE_CODES:2XX,404,405}
		ttl {$TTL:6000}
		purge_path {$PURGE_PATH:/__cache/purge}
		purge_key {$PURGE_KEY}
		bypass_home {$BYPASS_HOME:false}
		bypass_path_prefixes {$BYPASS_PATH_PREFIXES:/wp-admin,/wp-json}
	}

	{$CADDY_SERVER_EXTRA_DIRECTIVES}

	php_server
}